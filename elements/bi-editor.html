<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">
<!-- iron elements-->
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-signals/iron-signals.html">
<!-- paper elements-->
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">

<!-- company elements -->
<link rel="import" href="company-bo.html">
<link rel="import" href="company-edit.html">
<link rel="import" href="company-list.html">
<link rel="import" href="company-calendar.html">
<!-- behaviors-->
<link rel="import" href="../behaviors/input-behavior.html">
<link rel="import" href="../behaviors/BI-behavior.html">

<!--
`bi-editor`
editor con el que vamos poder guardar los datos de entrada de los Grupos

@demo demo/index.html 
-->

<dom-module id="bi-editor">
  <template>
    <style>
      :host {
        display: block;

      }
    
    </style>

    <firebase-auth 
            app-name="form-polymerfire"
            id="auth" 
            user="{{user}}">
    </firebase-auth>

    <!-- path de los Grupos -->
    <firebase-query
            id="query"
            app-name="form-polymerfire"
            path="/grupos/[[user.uid]]"
            data="{{data}}">
    </firebase-query>

    <!-- path de la Agenda -->
     <firebase-query
            id="queryUpdate"
            app-name="form-polymerfire"
            path="/agenda/[[user.uid]]/[[month]]"
            data="{{calendar}}">
    </firebase-query>


     <!-- path del calendario-->
     <firebase-query
            id="queryCalendar"
            app-name="form-polymerfire"
            path="/agenda/[[user.uid]]/5"
            data="{{calendario}}">
    </firebase-query>

      
      
     

    <iron-signals on-iron-signal-delete="removeItem"></iron-signals>
     
    <iron-pages selected="{{section}}" attr-for-selected="name">

      <!-- creación de denuncias -->
      
       <div name="create">
       <iron-icon icon="clear" id="clearIcon"></iron-icon>
          <company-bo company="{{company}}" inputs="{{inputs}}"></company-bo>
          <paper-fab icon="done" id="saveButton"></paper-fab>  
          
       </div>

       <!-- lista de denuncias -->

      <div name="list">
      <paper-fab icon="add" id="createcompany"></paper-fab>

     


          <company-list data="[[data]]" company="[[company]]"></company-list>  
          
      </div>

  

      <!-- editor de Grupos -->

      <div name="editor">
          <company-edit id="editor"></company-edit>  
      </div>
          
   </iron-pages>

  </template>

  <script>
    Polymer({

      is: 'bi-editor',

      properties: {
         user:Object,
         logueado: Boolean,
         data:Array,
         calendar:Array,
         company:Object,
         // propiedad que hace referencia al mes del path de la agenda
         month:Number,
        // propiedad que hace referencia al mes actual del path de la agenda, que será deletado cuando reagendemos el vencimiento  
         atualMonth:Number,
        // key del grupo dentro del path de la Agenda
         calendarKey:String,

         
        
         section:{
            type:String,
            value:'list'
         },     
      },

      behaviors: [Polymer.inputBehavior, Polymer.BIBehavior],

      listeners:{
         'saveButton.tap': 'save',    
         'createcompany.tap': 'create',
         'deletecompany': 'removeItem',
         'edition': 'editcompany',
         'send': 'sendcompany',
         'closeEditor':'backList',
         'clearIcon.tap': 'backList',
         'monthUpdate': 'setMonth',
         'rescheduleEdit': 'reschedule',      
       
     },

    

     // enlace con el componente <set-update>. Month será el filtro para guardar la fecha de la revisión en el mes correspondiente en la agenda de Firebase
     setMonth:function(e,monthUpdate){
        this.month = monthUpdate;

     },
  
      // método para guardar los datos de la denuncia en Firebase
      save:function(){

        if(!this.user){
          this.fire('negative-toast', 'você deve estar autenticado');
          return false;
        }      
   
        if(this.company.identificador && this.company.descripcion && this.company.expireDate){

          var calendarData = {
                identificador: this.company.identificador,
                expireDate: this.company.expireDate
          };    
           // generamos una key (id) para el Grupo que será la misma para las 2 ramas
          var newCompanyKey = this.$.query.ref.push().key;
            // subida de datos al path de la Agenda
          var calendarUpdates = {};
            // representa al path          =   datos a subir al path
          calendarUpdates[newCompanyKey] = calendarData;
            // subida de datos al path de los Grupos
          var companyUpdates = {};
          companyUpdates[newCompanyKey] = this.company;

            // tenemos que usar 'update' en lugar de 'push' porque este último siempre genera una 'key', por lo que se generarían 2 keys
          this.$.queryUpdate.ref.update(calendarUpdates)
            .catch(function(error){
              this.fire('negative-toast', 'error: ' + error);
            }.bind(this));

          this.$.query.ref.update(companyUpdates)
            .then(function(){

              

                this.fire('positive-toast', 'Grupo cadastrado');
                    // después de introducir los valores en los input se limpia el texto. Fijamos tanto la fecha como la dirección, ya que si los limpiamos el sistema no genera de nuevo esos valores. Behavior 'animilia-behavior'
                this.resetCompany();
                   // una vez guardada la denuncia, volvemos a mostrar el listado de denuncias 
                this.backList();
                 // enlace con <set-update> para limpiar el vencimiento seleccionado cuando se guarde un grupo
                this.fire('iron-signal', {name: 'cleardate'});
              }.bind(this))
            .catch(function(error){
                this.fire('negative-toast', 'error: ' + error);
            }.bind(this));  
                        
        } else {
          // al clickar en el botón 'guardar' se lanza el mètodo validator, incluido en el behavior, que valida los inputs
          for(var i = 0; i < this.inputs.length; i++ ){
              this.validator(this.inputs[i])
           };  
              
        };                          
      },

    // borrado del grupo clickado en la lista. Enlace con el componente <company-list>
    removeItem:function(e,companyItem){
      // BI-behavior (atribuimos a la propiedad "month" del path de la Agenda el valor del mes para poder hacer el borrado)
       this.monthCalendar(companyItem.expireDate);
      // borramos los datos de la empresa en los dos paths de Firebase simultaneamente
       this.$.query.ref.child(companyItem.$key).remove();
       this.$.queryUpdate.ref.child(companyItem.$key).remove();
     
    },

     // edición del grupo clickado en la lista. Enlace del componente <company-list> con el componente <company-edit>. Recibimos el objeto de la denuncia 'companyItem' desde el componente <company-list> y se lo inyectamos a la propiedad 'item' del componente <company-edit>, para que podamos editar la denuncia. Tambièn le pasamos el path de la denuncia a travès de la propiedad 'path', de manera que podamos hacer el update a dicho path.
    editcompany:function(e,companyItem){

      this.section = 'editor';
      // componente <company-edit>
      this.$.editor.item = companyItem; // a la propiedad item (objeto) del componente <company-edit> le inyectamos el objeto 'companyItem' que recibimos que recibimos desde el componente <company-list>. Lo mismo para la propiedad 'path'
      this.$.editor.path = this.$.query.ref.child(companyItem.$key); 
      // es necesario que asignemos un valor a 'month' porque si no 'ref' nos dará 'undefined'
      // es necesario que alteremos la propiedad 'expireDate' porque la recibimos como un String, y necesitaremos manejar fechas 
     
      var dateString = companyItem.expireDate;
      var dateParts = dateString.split("/");
     
      var dateObject = new Date(dateParts[2], dateParts[1] - 1, dateParts[0]); // month is 0-based
      
      this.month = dateObject.getMonth(); 
     
      // 'atualMonth' lo usaremos para definir el path actual a ser borrado con la función 'reschedule' cuando editemos la fecha de vencimiento (expireDate)
      this.atualMonth = dateObject.getMonth();     
      // operativa para tener acceso a la key del Grupo en la Agenda, que serà usada en la función reschedule para reagendar el vencimiento
      this.$.editor.pathCalendar =  this.$.queryUpdate.ref.child(companyItem.$key);
      this.calendarKey = this.$.editor.pathCalendar.path.o[3];
                
    },

      // enlace con el componente <company-edit>. Reagendado de los vencimientos
    reschedule:function(e,calendarUpdate){
         
      var calendarUpdates = {};
            // representa al path          =   datos a subir al path
      calendarUpdates[this.calendarKey] = calendarUpdate;    
      this.$.queryUpdate.ref.update(calendarUpdates)
          .then(function(){
              // atualaMonth se genera desde la función editcompany
              this.month = this.atualMonth;
              this.$.queryUpdate.ref.child(this.calendarKey).remove();
          }.bind(this))
          .catch(function(error){
                  this.fire('negative-toast', 'error: ' + error);
            }.bind(this));
    }, 

    create:function(){
      this.section = 'create';     
    },

    backList:function(){
      this.section = 'list'
    },


    // envio de la denuncia por email. El usuario tiene que tener un gestor de correo, sino no funciona. Como alternativa podemos elaborar codigo en NodeJS
    sendcompany:function(e,companyItem){
      window.location.href = "mailto:mail@example.org"
                          +"?subject="+"test"
                          +"&body="+companyItem.descripcion
    },

   
    

    });
  </script>
</dom-module>