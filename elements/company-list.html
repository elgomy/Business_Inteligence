<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">

<link rel="import" href="../bower_components/iron-signals/iron-signals.html">

<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-item/paper-item-body.html">
<link rel="import" href="../bower_components/iron-icons/editor-icons.html">

<!--
`company-list-BI`
lista de denuncias creadas en Animilia y almacenadas en Firebase

@demo demo/index.html 
-->

<dom-module id="company-list">
  <template>
    <style>
      :host {
        display: block;
      }

      paper-card{
          margin-bottom:10px;
      }

      paper-item{
        --paper-item:{
          background: #64FFDA;
        };
      }
    </style>


<iron-icon icon="event" on-tap="filterDialog"></iron-icon>

<!-- ENLACE CON MY-APP PARA LANZAR EL DIALOG DEL DATE-PICKER -->
<iron-signals on-iron-signal-filter="fiterPeriod"></iron-signals>

 
 <template id="template" is="dom-repeat" items="[[data]]" as="company" filter="{{computeFilter(startStamp,endStamp)}}">  
    <paper-item>
        <paper-item-body two-line>
          <div>[[company.identificador]]</div>
          <div secondary>Revisao: [[company.expireDate]]</div>
        </paper-item-body>
         <iron-icon icon="mail" company="[[company]]" on-tap="emailAlert"></iron-icon>
        <iron-icon icon="editor:mode-edit" company="[[company]]" on-tap="edition"></iron-icon>
        <iron-icon icon="clear" company="[[company]]" on-tap="remove" alt="deletar"></iron-icon>
    </paper-item>
</template>
 

  </template>

  <script>
    Polymer({

      is: 'company-list',

      properties:{
        data:Object,   
        company:Object,
        // propiedad a la que le atribuiremos el valor de la fecha de inicio seleccionada en el date-picker de Vaadin y que la usaremos para hacer el filtro a travès de la propiedad computada 'computeFilter'
        startStamp: Number,
        endStamp: Number
        
      },


       // el evento 'delete' se recibe en el componente <my-app> para poder abrir el 'dialog' 
      remove:function(e) {   
        var companyItem = e.currentTarget.company;
        this.fire('delete', companyItem) 
      },
      // enlace con <bi-editor>
      edition:function(e) {    
        var companyItem = e.currentTarget.company;
        this.fire('edition', companyItem);
       // console.log(companyItem) 
      },

      send:function(e) {    
        var companyItem = e.currentTarget.company;
        this.fire('send', companyItem) 
      },  
      // enlace con my-app
      filterDialog:function() {          
        this.fire('filterDialog') 
      }, 
       // enlace con my-app. En el paràmetro 'period' recibimos el objeto que contiene las fechas seleccionadas en el 'date-picker'
      fiterPeriod:function(e,period){
        this.startStamp = period.startStamp;
        this.endStamp = period.endStamp
      },

      // filtro dinàmico que variarà en función del valor de las propiedades 'startStamp' y 'endStamp'
      computeFilter:function(startStamp,endStamp){
            if (!startStamp || !endStamp){
                      return null // si no existen las 2 propiedades no se aplica el filtro
                  }else{
                    return function(item){
                        return (item.expireStamp >= startStamp) && (item.expireStamp <= endStamp+86400000) // 86400000 corresponden a 1 dia. Si no hacemos esto el filtro no incluirà aquellas grupos cuya data de revisiòn sea igual a la fecha de vencimiento seleccionada en el date-picker, porque tenemos que considerar que el timestamp cambia a cada segundo.
                  }                
                  
              }
           
      }, 

        // envio de la denuncia por email. El usuario tiene que tener un gestor de correo, sino no funciona. Como alternativa podemos elaborar codigo en NodeJS
    emailAlert:function(e){
      console.log(e.currentTarget.company.identificador)
      window.location.href = "mailto:mail@example.org"
                         +"?subject=" + "Revisão da empresa " + e.currentTarget.company.identificador.toUpperCase()
                          +"&body="+  "Prezado     ," + "%0D%0A" + "%0D%0A" + "La empresa " + e.currentTarget.company.identificador.toUpperCase() + " precisa ser revisada até o dia " + e.currentTarget.company.expireDate + ". Favor atualizar a documentação" + "%0D%0A" + "%0D%0A" + "Obrigado"
    },

       ready:function(){
      fecha = Date.now();
      console.log(fecha)
    } 

    });
  </script>
</dom-module>
