<link rel="import" href="../bower_components/polymer/polymer.html">
<!-- paper elements-->
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-expansion-panel/paper-expansion-panel.html">
<link rel="import" href="../bower_components/paper-dialog-behavior/paper-dialog-shared-styles.html">

<link rel="import" href="../bower_components/paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../bower_components/paper-collapse-item/paper-collapse-item.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="../bower_components/iron-signals/iron-signals.html">
<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">

<link rel="import" href="../bower_components/paper-item/paper-item.html">

<link rel="import" href="../bower_components/paper-item/paper-item-body.html">

<link rel="import" href="../bower_components/iron-icons/editor-icons.html">

<!--
`company-list-BI`
lista de denuncias creadas en Animilia y almacenadas en Firebase

@demo demo/index.html 
-->

<dom-module id="company-list">
  <template>
  <style include="shared-styles">

  paper-dialog{
        min-width: 220px;
        max-width: 350px;

        --paper-dialog:{
            background: blue
        
        };

        --paper-dialog-title:{
          color:red;
          text-align: center
        }
      
      }

  

     
      .dialogHeader{
        text-align: center
        background-color:blue;
      }

      .dialogContent{
        margin-left: 10px
      }


    
  </style>
     <style include="iron-flex iron-flex-alignment">
      :host {
        display: block;
      
      }

      paper-card{
                
            --paper-card:{
              margin:auto;
              width: 500px
            }
      }

      paper-item{      
         border-top:1px solid #eceff1;
      } 
    
      paper-item:hover{
        background-color: #fafafa;
        
      }

   
    /* el nombre del Grupo siempre en mayúsculas */
      paper-item-body #companyId {
        text-transform: uppercase;
        font-weight: bold     
      }  

      iron-icon{
        --iron-icon-width:20px;
      }

      
      
      .container{
           @apply(--layout-vertical);
           @apply(--layout-center);
           @apply(--layout-center-justified);
            background-color: #fafafa;
            height: 80px

      }

      .span{
        width: 200px;
        margin-top:10px;
      }

   

      paper-expansion-panel{
      

          --paper-expansion-panel-header: {
                text-transform: uppercase;
                font-weight: bold;
                border-bottom:1px solid #eceff1;
                font-family: "Averta","Avenir W02","Avenir",Helvetica,Arial,sans-serif;
                font-size: 14px;
                

          }

          --paper-expansion-panel-summary: {
              
               font-size: 12px;
          }

          --paper-expansion-panel-content:{
            border-bottom:1px solid #eceff1;
          }
        
        

      }

      .panel{
        @apply(--layout-horizontal);
        @apply(--layout-justified)
      }

    </style>

<div class="container">
         
          <span class="span" id="exp">Revisões vencidas: [[lengthExpired]]</span>
          
          <span class="span" id="forfive">Revisar < 45 dias: [[length45]]</span>
                 
         <paper-spinner-lite active id="spinner"></paper-spinner-lite>
    
</div>
    <!--   <p>Grupos a revisar menos de 45 dias:</p>
 <div id="revisar"></div>

  <p>Grupos vencidos:</p>
 <div id="vencidos"></div> -->
    







<!-- ENLACE CON MY-APP PARA LANZAR EL DIALOG DEL DATE-PICKER -->
<iron-signals on-iron-signal-filter="fiterPeriod"></iron-signals>

<iron-signals on-iron-signal-counteremove="counteremove"></iron-signals>

<iron-signals on-iron-signal-counteradd="counteradd"></iron-signals>

<!--
<iron-signals on-iron-signal-countereditminus="countereditminus"></iron-signals>

<iron-signals on-iron-signal-countereditplus="countereditplus"></iron-signals> -->

<iron-signals on-iron-signal-counteredit="counteredit"></iron-signals>

 
 <template id="template" is="dom-repeat" items="[[data]]" as="company" filter="{{computeFilter(startStamp,endStamp)}}" observe="item">  

    <paper-expansion-panel header="[[company.identificador]]" summary="[[company.expireDate]]">
      <div class="panel">
       
        <div id="companyData">
          <p><b>Revisão:</b> [[company.expireDate]] </p> 
          <p><b>Profile:</b> [[company.profile]] </p> 
          <p><b>Setor:</b> [[company.setor]] </p> 
          <p><b>Email do GG:</b> [[company.email]] </p> 
        </div>

         <div id="icons">
        <iron-icon icon="mail" company="[[company]]" on-tap="emailAlert"></iron-icon>
        <iron-icon icon="description" company="[[company]]" on-tap="edition"></iron-icon>
        <iron-icon icon="clear" company="[[company]]" on-tap="remove" alt="deletar"></iron-icon>
        </div>
      </div>

    </paper-expansion-panel>

<!--
    <paper-item id="test">
        <paper-item-body two-line>
          <div id="companyId" class="blue">[[company.identificador]]</div>
          <div secondary>Revisão: [[company.expireDate]] <iron-icon icon="warning" hidden$="[[warningHide]]"></iron-icon></div>

          
        <iron-collapse id$="collapse{{company.identificador}}">
              <iron-icon icon="mail" company="[[company]]" on-tap="emailAlert"></iron-icon>
        <iron-icon icon="description" company="[[company]]" on-tap="edition"></iron-icon>
        <iron-icon icon="clear" company="[[company]]" on-tap="remove" alt="deletar"></iron-icon>
          </iron-collapse>

        </paper-item-body>
         
        <iron-icon icon="expand-more" on-tap="showDetails"></iron-icon>
        <iron-icon icon="info-outline" on-tap="showInfo"></iron-icon>



    </paper-item> -->

    <paper-dialog id$="dialog{{company.identificador}}">
         <h2 class="dialogHeader">[[company.identificador]]</h2>
         <paper-dialog-scrollable>
         <div class="dialogContent">
          <p><b>Revisão:</b> [[company.expireDate]] </p> 
          <p><b>Profile:</b> [[company.profile]] </p> 
           <p><b>Setor:</b> [[company.setor]] </p> 
            <p><b>Email do GG:</b> [[company.email]] </p> 
            </div>
        </paper-dialog-scrollable>
     
</paper-dialog>


</template> 



<!--
 <template id="template" is="dom-repeat" items="[[data]]" as="company" filter="{{computeFilter(startStamp,endStamp)}}">  
    <paper-collapse-item header="[[company.identificador]]">
        
         <iron-icon icon="mail" company="[[company]]" on-tap="emailAlert"></iron-icon>
        <iron-icon icon="description" company="[[company]]" on-tap="edition"></iron-icon>
        <iron-icon icon="clear" company="[[company]]" on-tap="remove" alt="deletar"></iron-icon>
             <iron-icon icon="mail" company="[[company]]" on-tap="emailAlert"></iron-icon>
        <iron-icon icon="description" company="[[company]]" on-tap="edition"></iron-icon>
        <iron-icon icon="clear" company="[[company]]" on-tap="remove" alt="deletar"></iron-icon>
    </paper-collapse-item>
</template>   -->


 

  </template>

  <script>
    Polymer({

      is: 'company-list',

      properties:{
        data:{
          type:Object,
          
        },

        company:Object,
        // propiedad a la que le atribuiremos el valor de la fecha de inicio seleccionada en el date-picker de Vaadin y que la usaremos para hacer el filtro a travès de la propiedad computada 'computeFilter'
        startStamp: Number,
        endStamp: Number,
        warningHide:{
          type:Boolean,
          value:true
        },

        alert45:{
          type:Array,
          value: function(){
              return []
          }         
        },

         expired:{
          type:Array,
          value: function(){
              return []
          }         
        },
        period_45:{
          type:Number,
          value: Date.now() + 3888000000
        },

        length45:Number,
        lengthExpired: Number
        
      },

      test:function(e,expireDate){
        console.log(expireDate)
      },

   //  observers:['cambio(alert45.splices)'],

   //  cambio:function (value) {
   //    console.log(value)
   //  },

    // método que actualiza el contador cuando eliminamos algún grupo. Enlace con el mètodo 'removeItem' de <bi-editor> a travès de iron-signal
     counteremove:function (e,expireStamp) {
     // var todayStamp = Date.now();
     // var period_45 = todayStamp + 3888000000;

      if (expireStamp == 'vencido'){
          this.lengthExpired = this.lengthExpired -1 
        return false
      }

      if(expireStamp < this.period_45){
        this.length45 = this.length45 -1; 
        return false
      }
     },

      counteradd:function (e,expireStamp) {
    //   var todayStamp = Date.now();
     //  var period_45 = todayStamp + 3888000000;

       if(expireStamp < this.period_45){
        this.length45 = this.length45 +1; 
        return false
      }

     },

   //  countereditminus:function(e){
  //        this.length45 = this.length45 -1; 
    // },

   //  countereditplus:function(e){
   //     this.length45 = this.length45 +1; 
   //  },

     counteredit:function(e,plusminus){
        if (plusminus == 'plus'){
           this.length45 = this.length45 +1; 
        } else if (plusminus == 'minus')
            this.length45 = this.length45 -1
     },

      // Handling events in dom-repeat templates https://www.polymer-project.org/1.0/docs/devguide/templates
      showDetails:function(e,detail,sender){
        var id = e.model.company.identificador;
        var selector = '#collapse' + id;
        this.$$(selector).toggle();
      },

       showInfo:function(e,detail,sender){
        var id = e.model.company.identificador;
        var selector = '#dialog' + id;
        this.$$(selector).open();
      },

       // el evento 'delete' se recibe en el componente <my-app> para poder abrir el 'dialog' 
      remove:function(e) {   
        var companyItem = e.currentTarget.company;
        this.fire('delete', companyItem) 
      },
      // enlace con <bi-editor>
      edition:function(e) {    
        var companyItem = e.currentTarget.company;
        this.fire('edition', companyItem);
        this.fire('iron-signal', {name: 'setoldate', data: companyItem});
       // console.log(companyItem) 
      },

      send:function(e) {    
        var companyItem = e.currentTarget.company;
        this.fire('send', companyItem) 
      },  
      
       // enlace con my-app. En el paràmetro 'period' recibimos el objeto que contiene las fechas seleccionadas en el 'date-picker'
      fiterPeriod:function(e,period){
        this.startStamp = period.startStamp;
        this.endStamp = period.endStamp
      },

      // filtro dinàmico que variarà en función del valor de las propiedades 'startStamp' y 'endStamp'
      computeFilter:function(startStamp,endStamp){
            if (!startStamp || !endStamp){
                      return null // si no existen las 2 propiedades no se aplica el filtro
                  }else{
                    return function(item){
                        return (item.expireStamp >= startStamp) && (item.expireStamp <= endStamp+86400000) // 86400000 corresponden a 1 dia. Si no hacemos esto el filtro no incluirà aquellas grupos cuya data de revisiòn sea igual a la fecha de vencimiento seleccionada en el date-picker, porque tenemos que considerar que el timestamp cambia a cada segundo.
                  }                
                  
              }
           
      }, 

        // envio de la denuncia por email. El usuario tiene que tener un gestor de correo, sino no funciona. Como alternativa podemos elaborar codigo en NodeJS
    emailAlert:function(e){
      var company = e.currentTarget.company;
      window.location.href = "mailto:" + company.email
                         +"?subject=" + "Revisão da empresa " + company.identificador.toUpperCase()
                          +"&body="+  "Prezado     ," + "%0D%0A" + "%0D%0A" + "La empresa " + company.identificador.toUpperCase() + " precisa ser revisada até o dia " + company.expireDate + ". Favor atualizar a documentação" + "%0D%0A" + "%0D%0A" + "Obrigado"
    },
    // ponemos los contadores a 0 y a continuación lanzamos el mètodo 'timer' de manera asíncrona para dar tiempo al dom-repeat a que cargue la lista de grupos y de esa manera actualizamos los contadores
    ready:function(){  
      this.lengthExpired = 0;  
      this.length45 = 0;
      this.async(this.timer,[4000])
    //  console.log(this.company)
    },

    // método que acciona el control de las empresas cuya revisión debe ser dentro de los próximos 45 dias, y aquellas que ya vencieron
    timer:function(){

   //  console.log(this.alert45);
      var todayStamp = Date.now();
     // var period_30 = todayStamp + 2592000000;
     // var period_45 = todayStamp + 3888000000;

      
          
      for(i in this.data){

        if (this.data[i].expireStamp == 'vencido' || this.data[i].expireStamp <= todayStamp){
                
          // enlace con <bi-editor> para actualizar las propiedades 'expireStamp' y 'expireDate' para 'vencido'
          this.fire('setExpired', this.data[i].$key);
          this.warningHide = false;
          this.push('expired',this.data[i].identificador);      
          this.lengthExpired = this.expired.length ;       
   
        }
      
        else if (this.data[i].expireStamp < this.period_45){
               
         this.push('alert45',this.data[i].identificador);        
         this.length45 = this.alert45.length; 
             
   
        }
      }

      this.$.spinner.active = false;
    }

    });
  </script>
</dom-module>
